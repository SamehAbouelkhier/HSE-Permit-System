<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุชุตุงุฑูุญ ุงูุนูู ุงูููุญุฏ (AI-PTW) - PSM Compliance</title>
    <style>
        /* =============================
           1. ุงูุชุตููู (CSS)
           ============================= */
        
        .color-bar {
            height: 10px;
            width: 100%;
            background-color: #d9534f;
            margin-bottom: 20px;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.3s;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            margin: 20px;
            color: #333;
        }
        .permit-container {
            max-width: 850px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ุชูุณูู ุงูุชุฑููุณุฉ */
        .company-header {
            overflow: auto; 
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid #d9534f;
        }
        .logo-and-info {
            float: left;
            display: flex;
            align-items: center;
        }
        .logo-container {
            margin-left: 10px;
        }
        .logo-container img {
            max-width: 80px;
            height: auto;
            display: block;
        }
        .safety-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .safety-info p {
            margin: 0;
            line-height: 1.3;
        }
        .safety-info .sub-dept {
            color: #4CAF50;
            font-size: 15px;
            font-weight: bold;
        }
        
        /* ุงูุนููุงู ุงูุฑุฆูุณู */
        #permit-title {
            color: #d9534f;
            padding-bottom: 10px;
            text-align: center;
            margin-top: 15px;
            border-bottom: none; 
            transition: color 0.3s;
        }

        /* ุชูุณููุงุช ุงููููุฐุฌ */
        .form-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea {
            width: 98%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            margin-bottom: 10px;
        }
        textarea { resize: vertical; }
        .hard-stop {
            background-color: #f2dede;
            border-color: #a94442;
            color: #a94442;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
        }
        .ai-check {
            background-color: #d9edf7;
            border-color: #31708f;
            color: #31708f;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        button {
            background-color: #d9534f; 
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        button:hover {
            opacity: 0.9;
        }

        /* ุฅุฎูุงุก ุงูุฃูุณุงู ุบูุฑ ุงููุทููุจุฉ ูุจุฏุฆูุงู */
        .type-specific-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="permit-container">
        <div id="permit-color-bar" class="color-bar"></div>
        
        <div class="company-header">
            <div class="logo-and-info">
                <div class="logo-container">
                    <img src="logo.png" alt="ุดุนุงุฑ ุงูุดุฑูุฉ">
                </div>
                <div class="safety-info">
                    <p class="sub-dept">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุณูุงูุฉ ูุงูุตุญุฉ ุงูููููุฉ ูุญูุงูุฉ ุงูุจูุฆุฉ</p>
                </div>
            </div>
            <h2 id="permit-title">ุชุตุฑูุญ ุงูุนูู ุงูุณุงุฎู - AI-PTW</h2>
        </div>
        
        <div class="form-group">
            <label for="permit-type">**ุงุฎุชุฑ ููุน ุชุตุฑูุญ ุงูุนูู ุงููุทููุจ:**</label>
            <select id="permit-type" onchange="updatePermitType(); runAILogic();">
                <option value="HotWork" selected>1. ุงูุนูู ุงูุณุงุฎู (Hot Work)</option>
                <option value="ConfinedSpace">2. ุฏุฎูู ุงูุฃูุงูู ุงููุบููุฉ (Confined Space)</option>
                <option value="ColdWork">3. ุงูุนูู ุงูุจุงุฑุฏ (Cold Work)</option>
                <option value="Height">4. ุงูุนูู ุนูู ุงุฑุชูุงุนุงุช (Working at Height)</option>
                <option value="Excavation">5. ุงูุญูุฑ (Excavation)</option>
            </select>
        </div>

        
        <div class="form-group">
            <h3>I. ูุนูููุงุช ุงูุนูู ุงูุฃุณุงุณูุฉ</h3>
            <label for="work-order">ุฑูู ุฃูุฑ ุงูุตูุงูุฉ (SAP Work Order ID):</label>
            <input type="text" id="work-order" value="WO-5501">
            <label for="location">ูููุน ุงูุนูู:</label>
            <select id="location">
                <option value="T-105" selected>ููุทูุฉ ุงููุณุชูุฏุนุงุช 105</option>
                <option value="Pump-102">ุทููุจุฉ P-102</option>
                <option value="Tank-501">ุฎุฒุงู T-501 (ููุงู ูุบูู)</option>
                <option value="Pipe-Rack">ููุตุฉ ุงูุฃูุงุจูุจ (ุงุฑุชูุงุน)</option>
            </select>
            <label for="start-date">ุชุงุฑูุฎ ูููุช ุจุฏุก ุงูุนูู:</label>
            <input type="date" id="start-date" value="2025-01-01">
            <input type="time" id="start-time" value="08:00">
            <div id="duration-check" class="ai-check">โ ุตูุงุญูุฉ ุงูุชุตุฑูุญ ุถูู ุงููุนูุงุฑ ุงูููุงุณู (8 ุณุงุนุงุช).</div>
        </div>

        <div id="gas-check-section" class="form-group">
            <h3>II. ูุญุต ุงูุฃุฌูุงุก ูุงูุบุงุฒุงุช</h3>
            <label for="oxygen-reading">ูุณุจุฉ ุงูุฃูุณุฌูู (% O2):</label>
            <input type="number" id="oxygen-reading" value="20.9" step="0.1" min="0" max="100">
            <label for="lel-reading">ุชุฑููุฒ ุงูุบุงุฒุงุช ุงููุงุจูุฉ ููุงุดุชุนุงู (LEL %):</label>
            <input type="number" id="lel-reading" value="0" min="0" max="100">
            <label for="h2s-reading">ุชุฑููุฒ ุงูุบุงุฒุงุช ุงูุณุงูุฉ (H2S - ppm):</label>
            <input type="number" id="h2s-reading" value="0" min="0" max="50">
            <div id="gas-hard-stop" class="hard-stop">โ ุฑูุถ ููุฑู: ูุฑุงุกุงุช ุงูุฃุฌูุงุก ุบูุฑ ุขููุฉ.</div>
        </div>

        <div class="form-group">
            <h3>III. ุชูููู ุงููุฎุงุทุฑ ูุฅุฏุงุฑุฉ ุงูุชุบููุฑ (PSM)</h3>
            <label for="moc-check">ูู ูุชุถูู ุงูุนูู ุชุบููุฑูุง ุบูุฑ ุฑูุชูููุ (ุฅุฏุงุฑุฉ ุงูุชุบููุฑ MOC)</label>
            <select id="moc-check">
                <option value="No" selected>ูุง/ุนูู ุฑูุชููู</option>
                <option value="Yes">ูุนู/ุชู ุฅุตุฏุงุฑ MOC</option>
                <option value="Pending">ูุนู/MOC ููุฏ ุงููุฑุงุฌุนุฉ</option>
            </select>
            <div id="moc-warning" class="ai-check" style="display: none;">โ๏ธ ุชูุจูู MOC: ูุฌุจ ุฅููุงุก ูุฑุงุฌุนุฉ MOC ูุจู ุงูุฅุฑุณุงู.</div>
            
            <label for="risk-rating" style="margin-top: 10px;">ุชุตููู ุงููุฎุงุทุฑ ุงููุชุจููุฉ ุจุนุฏ ุชุทุจูู ุงูุงุญุชูุงุทุงุช:</label>
            <select id="risk-rating">
                <option value="High">ูุฑุชูุนุฉ (ูููุบู ุงูุชุตุฑูุญ)</option>
                <option value="Medium" selected>ูุชูุณุทุฉ</option>
                <option value="Low">ููุฎูุถุฉ</option>
            </select>
            <div id="risk-hard-stop" class="hard-stop" style="display: none;">โ ุฑูุถ ููุฑู: ูุง ููุณูุญ ุจุฃุนูุงู ุชุชุถูู ูุฎุงุทุฑ "ูุฑุชูุนุฉ".</div>
        </div>
        
        <div class="form-group">
            <h3 id="checklist-title">IV. ุงูุดุฑูุท ุงูุฅูุฒุงููุฉ ูุงูุงุญุชูุงุทุงุช (PSM/ูุงููู ุงูุนูู)</h3>
            <div id="dynamic-checklist">
                </div>
            <div id="essential-checklist-hard-stop" class="hard-stop" style="display: none;">โ ุฑูุถ ููุฑู: ูุฌุจ ุชุฃููุฏ ุฌููุน ุจููุฏ ุงูุงุญุชูุงุทุงุช ุงูุฅูุฒุงููุฉ.</div>
        </div>

        <div class="form-group">
            <h3>V. ูุตู ุงูุนูู ูุงูุฃุฏูุงุช</h3>
            <label for="work-details">**ูุตู ุชูุตููู ููุนูู ุงูููุฑุงุฏ ุชูููุฐู:**</label>
            <textarea id="work-details" rows="4" placeholder="ุงูุชุจ ููุง ุชูุงุตูู ุฏูููุฉ ููุนูู..."></textarea>
            
            <label for="tools">ุงูุฃุฏุงุฉ ุงูุฑุฆูุณูุฉ (ููุชุฏููู):</label>
            <select id="tools">
                <option value="ูุญุงู">ูุงูููุฉ ูุญุงู ููุฑุจุงุฆูุฉ</option>
                <option value="ุตุงุฑูุฎ">ุตุงุฑูุฎ ูุทุน/ุฌูุฎ (ููุฑุจุงุฆู)</option>
                <option value="ูุฏูู" selected>ุฃุฏูุงุช ูุฏููุฉ (ูููุงุช/ููุงุชูุญ)</option>
                <option value="ุญูุฑ">ุญูุงุฑุฉ ูุฏููุฉ/ูููุงููููุฉ</option>
                <option value="ุณูุงูุฉ">ุชุฑููุจ/ูู ุณูุงูุฉ</option>
            </select>
            <div id="contradiction-check" class="ai-check">โ ุฌุงุฑู ุงูุชุฏููู ุงูุขูู...</div>
        </div>

        <div class="form-group">
            <h3>VI. ูุชุทูุจุงุช ุงูุนุฒู (Isolation / LOTO)</h3>
            <label>ุงูุชุฃูุฏ ูู ุชุทุจูู ุงูุนุฒู ุงููุงุฒู ูููุนุฏุฉ:</label>
            <label><input type="checkbox" id="iso-electrical"> 1. ุงูุนุฒู ุงูููุฑุจุงุฆู (Lockout)</label><br>
            <label><input type="checkbox" id="iso-mechanical"> 2. ุงูุนุฒู ุงููููุงูููู/ุงููุตู (Blinding)</label><br>
            <label><input type="checkbox" id="iso-pressure"> 3. ุชูุฑูุบ ูุชุตููุฉ ุงูุถุบุท/ุงูุณูุงุฆู</label><br>
            <label><input type="checkbox" id="iso-chemicals"> 4. ุบุณูู ุงููุนุงุก/ุงูููุงุณูุฑ (Flushing)</label><br>
            <div id="isolation-check" class="ai-check">โ ูุฌุจ ุชุฃููุฏ ูุชุทูุจุงุช ุงูุนุฒู ุงููุงุฒูุฉ ููุนูู.</div>
        </div>

        <div class="form-group">
            <h3>VII. ุชุญุฏูุฏ ุงููุณุคูููุงุช ูุงูุงุนุชูุงุฏุงุช</h3>
            <label>1. ุงูููุตุฑุญ ุจุงูุนูู (Issuing Authority - ุงูุชุดุบูู/ุงูุฌูุฉ ุงููุตุฏุฑุฉ):</label>
            <input type="text" id="issuer-name" placeholder="ุงุณู ูุณุคูู ุงูุชุตุฑูุญ">
            
            <label>2. ุงูููุดุฑู ุงูููููุฐ ููุนูู (Supervisor):</label>
            <input type="text" id="executor-supervisor" placeholder="ุงุณู ุงููุดุฑู ุงููุงุฆู ุนูู ุงูุชูููุฐ">
            
            <label>3. ูุณุคูู ุงูุณูุงูุฉ ูุงูุตุญุฉ ุงูููููุฉ (HSE Officer):</label>
            <input type="text" id="hse-officer-name" placeholder="ุงุณู ูุณุคูู ุงูุณูุงูุฉ ุงููุนุชูุฏ">

             <div id="attendant-input-group" class="type-specific-section">
                <label>4. ูุฑุงูุจ ุงูุณูุงูุฉ (Fire Watch / Attendant):</label>
                <input type="text" id="attendant-name" placeholder="ุงุณู ูุฑุงูุจ ุงูุณูุงูุฉ ุงููุนูู/ูุฑุงูุจ ุงูุญุฑูู">
            </div>
            
            <div id="signature-check" class="ai-check">โ ููุฑุฌู ุฅุฏุฎุงู ุฃุณูุงุก ุงููุณุคูููู ูููุชุงุจุนุฉ.</div>
        </div>
        
        <div class="form-group">
            <h3>VIII. ุงูุงุญุชูุงุทุงุช ุงูููุถุงูุฉ (ุชูุจุคุงุช AI)</h3>
            <div id="ai-predictions"><p class="ai-check">โ ุงูุชุฏููู ุงููุฎุตุต ุงููุจุฏุฆู ูููุนู.</p></div>
        </div>

        <button id="submit-permit" disabled>ูุฌุจ ุญู ุฌููุน ุงููุดููุงุช ูุจู ุงูุฅุฑุณุงู</button>
        <button id="print-permit" style="display: none; background-color: #337ab7; margin-top: 10px;">๐จ๏ธ ุทุจุงุนุฉ ุงูุชุตุฑูุญ ุงููุนุชูุฏ</button>
        <div id="api-status" class="ai-check" style="display:none; margin-top:10px;"></div>
    </div>
    
    <script>
        // ===================================
        // 2. ููุทู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุฏููุงููููุฉ (JavaScript)
        // ===================================

        // 1. ุชุนุฑูู ุงููุชุบูุฑุงุช ุงูุฑุฆูุณูุฉ
        const elements = {
            permitType: document.getElementById('permit-type'),
            colorBar: document.getElementById('permit-color-bar'),
            permitTitle: document.getElementById('permit-title'),
            submitButton: document.getElementById('submit-permit'),
            printButton: document.getElementById('print-permit'),
            apiStatus: document.getElementById('api-status'), // ูุนุฑุถ ุญุงูุฉ API
            // ุงูุฃูุณุงู ุงูุฏููุงููููุฉ
            gasCheckSection: document.getElementById('gas-check-section'),
            dynamicChecklist: document.getElementById('dynamic-checklist'),
            checklistTitle: document.getElementById('checklist-title'),
            attendantInputGroup: document.getElementById('attendant-input-group'),
            // ุงูุฅุฏุฎุงูุงุช ูุงููุฑุงุกุงุช
            oxygenReading: document.getElementById('oxygen-reading'),
            lelReading: document.getElementById('lel-reading'),
            h2sReading: document.getElementById('h2s-reading'),
            riskRating: document.getElementById('risk-rating'),
            mocCheck: document.getElementById('moc-check'),
            workDetails: document.getElementById('work-details'),
            tools: document.getElementById('tools'),
            // ุงูุนุฒู ูุงูุชูููุนุงุช
            isoElectrical: document.getElementById('iso-electrical'),
            isoMechanical: document.getElementById('iso-mechanical'),
            isoPressure: document.getElementById('iso-pressure'),
            isoChemicals: document.getElementById('iso-chemicals'),
            issuerName: document.getElementById('issuer-name'), 
            executorSupervisor: document.getElementById('executor-supervisor'), 
            hseOfficerName: document.getElementById('hse-officer-name'), 
            attendantName: document.getElementById('attendant-name'), 
            // Hard Stops & Warnings
            gasHardStop: document.getElementById('gas-hard-stop'),
            riskHardStop: document.getElementById('risk-hard-stop'),
            mocWarning: document.getElementById('moc-warning'),
            essentialChecklistHardStop: document.getElementById('essential-checklist-hard-stop'),
            isolationCheck: document.getElementById('isolation-check'),
            contradictionCheck: document.getElementById('contradiction-check'),
            signatureCheck: document.getElementById('signature-check'),
            aiPredictions: document.getElementById('ai-predictions'),
            locationSelect: document.getElementById('location')
        };
        
        // 2. ุชุนุฑูู ุฃูุธูุฉ ุงูุชุตุงุฑูุญ (ุงูุฃููุงู ูุงูุดุฑูุท)
        const PERMITS = {
            HotWork: {
                title: "ุชุตุฑูุญ ุงูุนูู ุงูุณุงุฎู",
                color: "#d9534f", // ุงูุฃุญูุฑ
                checklist: [
                    { id: 'fire-extinguisher', text: '1. ุชูููุฑ ุทูุงูุงุช ุญุฑูู ุณุงุฑูุฉ ูููุงุณุจุฉ.', default: true },
                    { id: 'combustible-materials', text: '2. ุฅุฒุงูุฉ ุงูููุงุฏ ุงููุงุจูุฉ ููุงุดุชุนุงู ูู ูุญูุท 10 ุฃูุชุงุฑ.', default: true },
                    { id: 'fire-watch-ready', text: '3. ุชุญุฏูุฏ ูุชุฌููุฒ ูุฑุงูุจ ุญุฑูู (ูุฑุงูุจ ุงูุณูุงูุฉ).', default: false }, 
                    { id: 'welding-blanket', text: '4. ุงุณุชุฎุฏุงู ุจุทุงููุฉ ุญุฑูู/ุญูุงุฌุฒ ุบูุฑ ูุงุจูุฉ ููุงุดุชุนุงู.', default: true }
                ],
                gasRequired: true,
                attendantRequired: true
            },
            ConfinedSpace: {
                title: "ุชุตุฑูุญ ุฏุฎูู ุงูุฃูุงูู ุงููุบููุฉ",
                color: "#337ab7", // ุงูุฃุฒุฑู
                checklist: [
                    { id: 'ventilation-check', text: '1. ุงูุชุฃูุฏ ูู ุชููุฑ ุงูุชูููุฉ ุงููุณุฑูุฉ ุงููุงููุฉ.', default: true },
                    { id: 'attendant-check', text: '2. ุชุนููู ูุฑุงูุจ ุณูุงูุฉ ูุคูู ูุฒูุฏ ุจุงุชุตุงู ูุณุชูุฑ.', default: false }, 
                    { id: 'rescue-plan', text: '3. ุชูููุฑ ูุนุฏุงุช ุฅููุงุฐ ุฌุงูุฒุฉ ูุฎุทุฉ ุฅููุงุฐ ูุนุชูุฏุฉ.', default: true },
                    { id: 'isolation-check-cs', text: '4. ุชุฃููุฏ ุงูุนุฒู ุงููุงูู ูููุฏุฎู ูุงููุฎุงุฑุฌ (Blinding/LOTO).', default: true }
                ],
                gasRequired: true,
                attendantRequired: true 
            },
            ColdWork: {
                title: "ุชุตุฑูุญ ุงูุนูู ุงูุจุงุฑุฏ",
                color: "#5cb85c", // ุงูุฃุฎุถุฑ
                checklist: [
                    { id: 'area-clean', text: '1. ุชูุธูู ููุทูุฉ ุงูุนูู ูู ุฃู ุนูุงุฆู ุฃู ุงูุณูุงุจุงุช.', default: true },
                    { id: 'tool-safe', text: '2. ูุญุต ุณูุงูุฉ ุฌููุน ุงูุฃุฏูุงุช ุงููุฏููุฉ ูุงูููุฑุจุงุฆูุฉ (ุฅู ูุฌุฏุช).', default: true },
                    { id: 'trip-hazard', text: '3. ุชุฃููู ุงูุฃุณูุงู ูุงููุงุจูุงุช ูุชุฌูุจ ูุฎุงุทุฑ ุงูุชุนุซุฑ.', default: true }
                ],
                gasRequired: false,
                attendantRequired: false
            },
            Height: {
                title: "ุชุตุฑูุญ ุงูุนูู ุนูู ุงุฑุชูุงุนุงุช",
                color: "#f0ad4e", // ุงูุฃุตูุฑ
                checklist: [
                    { id: 'harness-check', text: '1. ูุญุต ุญุฒุงู ุงูุฃูุงู (Full Body Harness) ูููุทุฉ ุงูุฑุจุท.', default: true },
                    { id: 'scaffolding-tag', text: '2. ุงูุชุฃูุฏ ูู ุฃู ุงูุณูุงูุฉ/ุงูููุตุฉ ุชุญูู "ุจุทุงูุฉ ุฎุถุฑุงุก" ุณุงุฑูุฉ.', default: true },
                    { id: 'fall-protection', text: '3. ุชุฃููู ุงูุญูุงูุฉ ูู ุงูุณููุท (ุญูุงุฌุฒ ุฃู ุดุจูุงุช) ูู ูุญูุท ุงูุนูู.', default: true }
                ],
                gasRequired: false,
                attendantRequired: false
            },
            Excavation: {
                title: "ุชุตุฑูุญ ุงูุญูุฑ",
                color: "#8a6d3b", // ุงูุจูู
                checklist: [
                    // ุชู ุงูุชุนุฏูู: ุฅุถุงูุฉ ุงูุฅุฏุงุฑุงุช ุงููุนููุฉ
                    { id: 'utility-permits', text: '1. ููุงููุฉ ุงูุฅุฏุงุฑุงุช ุงููุนููุฉ ุจูุงูุฉ ุงููุฑุงูู (ููุฑุจุงุกุ ูุฏููุฉุ ุดุจูุงุชุ ุฅูุฎ).', default: false }, 
                    { id: 'permit-to-dig', text: '2. ุงูุญุตูู ุนูู ุชุตุฑูุญ ุงูุญูุฑ (Permit to Dig) ูู ุงูุฃุทุฑุงู ุงููุนููุฉ.', default: false }, 
                    { id: 'utility-checked', text: '3. ุงูุชุญูู ูู ุงููุฑุงูู ุงูุฌูููุฉ (ูุงุจูุงุช/ููุงุณูุฑ) ุจูุงุณุทุฉ ูุฎุทุทุงุช ูุชุฃููุฏ ุงููููุน.', default: true },
                    { id: 'shoring-needed', text: '4. ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ุชุฏุนูู ุฌูุงูุจ ุงูุญูุฑ (Shoring) ูุทููุจุงู.', default: true },
                    { id: 'access-check', text: '5. ุชูููุฑ ูุณุงุฆู ุฏุฎูู ูุฎุฑูุฌ ุขููุฉ (ุณูุงูู/ููุญุฏุฑุงุช) ุฅุฐุง ุฒุงุฏ ุงูุนูู ุนู 1.2 ูุชุฑ.', default: true }
                ],
                gasRequired: true, 
                attendantRequired: false
            }
        };

        // 3. ุฏุงูุฉ ุชุญุฏูุซ ุงููุงุฌูุฉ ุนูุฏ ุชุบููุฑ ููุน ุงูุชุตุฑูุญ
        function updatePermitType() {
            const type = elements.permitType.value;
            const config = PERMITS[type];

            // 1. ุชุญุฏูุซ ุงูููู ูุงูุนููุงู
            elements.colorBar.style.backgroundColor = config.color;
            elements.permitTitle.style.color = config.color;
            elements.permitTitle.textContent = config.title + " - AI-PTW";
            elements.submitButton.style.backgroundColor = config.color;
            elements.printButton.style.backgroundColor = config.color;

            // 2. ุชุญุฏูุซ ูุณู ูุญุต ุงูุบุงุฒุงุช (ุฅุธูุงุฑ/ุฅุฎูุงุก)
            elements.gasCheckSection.style.display = config.gasRequired ? 'block' : 'none';

            // 3. ุชุญุฏูุซ ูุงุฆูุฉ ุงูุดุฑูุท ุงูุฅูุฒุงููุฉ (IV)
            let checklistHTML = '';
            config.checklist.forEach(item => {
                checklistHTML += `
                    <label>
                        <input type="checkbox" id="check-${item.id}" ${item.default ? 'checked' : ''} onchange="runAILogic()">
                        ${item.text}
                    </label><br>
                `;
            });
            elements.dynamicChecklist.innerHTML = checklistHTML;
            elements.checklistTitle.textContent = `IV. ุงูุดุฑูุท ุงูุฅูุฒุงููุฉ ูุงูุงุญุชูุงุทุงุช ูู (${config.title})`;
            
            // 4. ุชุญุฏูุซ ุญูู ูุฑุงูุจ ุงูุณูุงูุฉ (ุฅุธูุงุฑ/ุฅุฎูุงุก)
            elements.attendantInputGroup.style.display = config.attendantRequired ? 'block' : 'none';
        }


        // 4. ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ูุชุดุบูู ุงูููุทู ุงูุฐูู (ุจูุงุกู ุนูู ููุน ุงูุชุตุฑูุญ ุงูุญุงูู)
        function runAILogic() {
            let canSubmit = true;
            const currentType = elements.permitType.value;
            const config = PERMITS[currentType];
            
            // ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุงูุฑููุถ ุงูุญุงุฏ
            Object.values(elements).forEach(el => {
                if (el && el.classList && el.classList.contains('hard-stop')) {
                    el.style.display = 'none';
                }
            });
            elements.mocWarning.style.display = 'none';

            // --- A. ุชุฏูููุงุช ุนุงูุฉ (PSM) ---

            // 1. ูุญุต ุงููุฎุงุทุฑ (High Risk)
            if (elements.riskRating.value === 'High') {
                elements.riskHardStop.style.display = 'block';
                canSubmit = false;
            } 

            // 2. ูุญุต MOC
            if (elements.mocCheck.value === 'Pending') {
                elements.mocWarning.style.display = 'block';
                elements.mocWarning.textContent = 'โ๏ธ ุชูุจูู MOC: ูุฌุจ ุฅููุงุก ูุฑุงุฌุนุฉ MOC ูุจู ุงูุฅุฑุณุงู.';
                canSubmit = false;
            }

            // 3. ูุญุต ุงูุดุฑูุท ุงูุฅูุฒุงููุฉ ุงูุฏููุงููููุฉ
            let checklistPassed = true;
            config.checklist.forEach(item => {
                const checkbox = document.getElementById(`check-${item.id}`);
                if (checkbox && !checkbox.checked) {
                    checklistPassed = false;
                }
            });
            if (!checklistPassed) {
                elements.essentialChecklistHardStop.style.display = 'block';
                canSubmit = false;
            }

            // 4. ูุญุต ุงูุชูููุนุงุช
            let signatureRequired = (
                elements.issuerName.value.trim() !== '' && 
                elements.executorSupervisor.value.trim() !== '' && 
                elements.hseOfficerName.value.trim() !== '' 
            );

            if (config.attendantRequired && elements.attendantName.value.trim() === '') {
                 signatureRequired = false; 
            }
            if (!signatureRequired) {
                elements.signatureCheck.textContent = 'โ ุฑูุถ ุฅูุฒุงูู: ูุฌุจ ุชุญุฏูุฏ ุฌููุน ุงููุณุคูููู (ุงูููุตุฑุญุ ุงูููุดุฑูุ ูุณุคูู ุงูุณูุงูุฉุ ููุฑุงูุจ ุงูุณูุงูุฉ ุฅู ูุฒู).';
                elements.signatureCheck.style.backgroundColor = '#f2dede';
                elements.signatureCheck.style.color = '#a94442';
                canSubmit = false;
            } else {
                elements.signatureCheck.textContent = 'โ ุชู ุชุญุฏูุฏ ุฌููุน ุงููุณุคูููู.';
                elements.signatureCheck.style.backgroundColor = '#d9edf7';
                elements.signatureCheck.style.color = '#31708f';
            }


            // --- B. ุชุฏูููุงุช ุฎุงุตุฉ ุจููุน ุงูุชุตุฑูุญ ---
            
            const lelValue = parseFloat(elements.lelReading.value);
            const o2Value = parseFloat(elements.oxygenReading.value);
            const h2sValue = parseFloat(elements.h2sReading.value); 

            let predictionsHtml = '';
            elements.aiPredictions.innerHTML = '';
            elements.contradictionCheck.textContent = 'โ ุฌุงุฑู ุงูุชุฏููู ุงูุขูู... ูุง ููุฌุฏ ุชูุงูุถ.';
            elements.contradictionCheck.style.backgroundColor = '#d9edf7';
            elements.contradictionCheck.style.color = '#31708f';

            if (config.gasRequired) {
                // *** ุชุฏููู H2S: ุญุฏ ุงูุฑูุถ > 10 ppm ***
                if (h2sValue > 10) {
                    elements.gasHardStop.textContent = `โ ุฑูุถ ููุฑู: ุชุฑููุฒ ุงูุบุงุฒุงุช ุงูุณุงูุฉ (H2S = ${h2sValue} ppm) ูุชุฌุงูุฒ ุงูุญุฏ ุงูุขูู (10 ppm).`;
                    elements.gasHardStop.style.display = 'block';
                    canSubmit = false;
                }
                // *** ุชุฏููู O2: ุฎุงุฑุฌ ุงูุญุฏูุฏ (19.5%-23.5%) ***
                else if (o2Value < 19.5 || o2Value > 23.5) {
                    const message = o2Value < 19.5 ? 'ููุต ุงูุฃูุณุฌูู' : 'ุฒูุงุฏุฉ ุงูุฃูุณุฌูู';
                    elements.gasHardStop.textContent = `โ ุฑูุถ ููุฑู: ูุฑุงุกุฉ ุงูุฃูุณุฌูู (${o2Value} %) ุฎุงุฑุฌ ุงูุญุฏูุฏ ุงูุขููุฉ ุจุณุจุจ ${message}.`;
                    elements.gasHardStop.style.display = 'block';
                    canSubmit = false;
                }
            }


            switch (currentType) {
                case 'HotWork':
                    // ุชุฏููู ุงูุบุงุฒุงุช ููุนูู ุงูุณุงุฎู (LEL ูุฌุจ ุฃู ูููู ุตูุฑุงู)
                    if (config.gasRequired && lelValue > 0) {
                        elements.gasHardStop.textContent = `โ ุฑูุถ ููุฑู: ูุฑุงุกุฉ ุงูุบุงุฒุงุช ุงููุงุจูุฉ ููุงุดุชุนุงู (LEL = ${lelValue} %) ูุฌุจ ุฃู ุชููู ุตูุฑุงู ููุนูู ุงูุณุงุฎู.`;
                        elements.gasHardStop.style.display = 'block';
                        canSubmit = false;
                    }
                    if (elements.tools.value !== 'ูุญุงู' && elements.tools.value !== 'ุตุงุฑูุฎ') {
                         elements.contradictionCheck.textContent = 'โ๏ธ ุชูุงูุถ: ุงูุชุตุฑูุญ ุณุงุฎู ูุงูุฃุฏุงุฉ ุงููุฎุชุงุฑุฉ ููุณุช ูููุฏุฉ ููุดุฑุฑ. ููุถู ุชุบููุฑ ุงูุชุตุฑูุญ ุฅูู "ุจุงุฑุฏ".';
                         elements.contradictionCheck.style.backgroundColor = '#faebcc';
                         elements.contradictionCheck.style.color = '#8a6d3b';
                    }
                    break;

                case 'ConfinedSpace':
                    // ุชุฏููู ุงูุบุงุฒุงุช ููุฃูุงูู ุงููุบููุฉ (LEL ูุฌุจ ุฃู ูููู ุตูุฑุงู)
                    if (config.gasRequired && lelValue > 0) {
                        elements.gasHardStop.textContent = `โ ุฑูุถ ููุฑู: ูุฑุงุกุฉ ุงูุบุงุฒุงุช ุงููุงุจูุฉ ููุงุดุชุนุงู (LEL = ${lelValue} %) ูุฌุจ ุฃู ุชููู ุตูุฑุงู ููุฃูุงูู ุงููุบููุฉ.`;
                        elements.gasHardStop.style.display = 'block';
                        canSubmit = false;
                    }
                    if (elements.tools.value === 'ูุญุงู' || elements.tools.value === 'ุตุงุฑูุฎ') {
                        predictionsHtml += '<p class="ai-check" style="background-color:#ffe0b2; color:#e65100;">๐จ ูุชุทูุจ ุฅุถุงูู: ููุฒู ูุญุต LEL ุจุดูู ูุณุชูุฑ ูุน ูุฌูุฏ ุฌูุงุฒ ุชููุณ ุงุญุชูุงุทู.</p>';
                    }
                    break;
                
                case 'Excavation':
                    // ุงูุฑูุถ ุงูููุฑู ูุนุฏู ููุงููุฉ ุงููุฑุงูู (ุงูุชุนุฏูู ุงููุทููุจ)
                    if (!document.getElementById('check-utility-permits').checked) {
                        elements.essentialChecklistHardStop.textContent = 'โ ุฑูุถ ููุฑู: ูุฌุจ ุชุฃููุฏ ููุงููุฉ ุฌููุน ุงูุฅุฏุงุฑุงุช ุงููุนููุฉ ุจุงููุฑุงูู (ููุฑุจุงุกุ ูุฏููุฉุ ุดุจูุงุช) ูุจู ุงูุญูุฑ.';
                        elements.essentialChecklistHardStop.style.display = 'block';
                        canSubmit = false;
                    } 
                    break;
            }
            
            elements.aiPredictions.innerHTML = predictionsHtml || '<p class="ai-check">โ ุงูุชุฏููู ุงููุฎุตุต ุงููุจุฏุฆู ูููุนู.</p>';

            // --- C. ุงูุชุญูู ุงูููุงุฆู ---
            elements.submitButton.disabled = !canSubmit;
            
            if (canSubmit) {
                elements.submitButton.textContent = `ุฅุฑุณุงู ููุงุนุชูุงุฏ ุนุจุฑ API (ุฌุงูุฒ - ${config.title})`;
                elements.printButton.style.display = 'block'; 
            } else {
                elements.submitButton.textContent = 'ูุฌุจ ุญู ุฌููุน ุงููุดููุงุช ูุจู ุงูุฅุฑุณุงู';
                elements.printButton.style.display = 'none'; 
            }
        }


        // ===================================
        // 5. ุฏุงูุฉ ุชุฌููุน ูุฅุฑุณุงู ุจูุงูุงุช JSON ุฅูู API (ุฌุฏูุฏุฉ)
        // ===================================
        
        async function sendPermitData() {
            const currentType = elements.permitType.value;
            const config = PERMITS[currentType];
            
            // 1. ุชุฌููุน ูุงุฆูุฉ ุงูุชุญูู ุงูุฏููุงููููุฉ (Checklist)
            const checklistData = config.checklist.map(item => {
                const checkbox = document.getElementById(`check-${item.id}`);
                return {
                    itemId: item.id,
                    text: item.text,
                    status: checkbox ? checkbox.checked : false
                };
            });

            // 2. ุชุฌููุน ุจูุงูุงุช ุงููุณุคูููู
            const personnelData = {
                issuer: {
                    name: elements.issuerName.value.trim(),
                    role: "Issuing Authority"
                },
                supervisor: {
                    name: elements.executorSupervisor.value.trim(),
                    role: "Executing Supervisor"
                },
                hseOfficer: {
                    name: elements.hseOfficerName.value.trim(),
                    role: "HSE Officer"
                }
            };

            // ุฅุถุงูุฉ ูุฑุงูุจ ุงูุณูุงูุฉ ุฅุฐุง ูุงู ูุทููุจูุง
            if (config.attendantRequired) {
                personnelData.attendant = {
                    name: elements.attendantName.value.trim(),
                    role: "Safety Attendant / Fire Watch"
                };
            }
            
            // 3. ุจูุงุก ูููู JSON ุงููุงูู
            const permitData = {
                requestID: 'PTW-TEMP-' + Date.now(), 
                
                permitHeader: {
                    workOrder: document.getElementById('work-order').value.trim(),
                    permitType: currentType,
                    locationCode: elements.locationSelect.value,
                    locationName: elements.locationSelect.options[elements.locationSelect.selectedIndex].text,
                    startDate: document.getElementById('start-date').value,
                    startTime: document.getElementById('start-time').value,
                    riskRating: elements.riskRating.value,
                    durationHours: 8 
                },
                
                workDescription: {
                    descriptionDetails: elements.workDetails.value.trim(),
                    mainTool: elements.tools.value,
                    mocStatus: elements.mocCheck.value
                },

                safetyMetrics: {
                    isGasCheckRequired: config.gasRequired,
                    oxygenReading: config.gasRequired ? parseFloat(elements.oxygenReading.value) : null,
                    lelReading: config.gasRequired ? parseFloat(elements.lelReading.value) : null,
                    h2sReading: config.gasRequired ? parseFloat(elements.h2sReading.value) : null,
                    fireWatchRequired: config.attendantRequired 
                },

                isolationChecks: {
                    isoElectrical: elements.isoElectrical.checked,
                    isoMechanical: elements.isoMechanical.checked,
                    isoPressure: elements.isoPressure.checked,
                    isoChemicals: elements.isoChemicals.checked
                },

                checklistStatus: checklistData,
                
                personnel: personnelData
            };

            // 4. ุงูุฅุฑุณุงู ุงููุนูู ุฅูู API
            
            const API_ENDPOINT = 'http://your-server-domain.com/api/permits/new'; 
            // ูุฌุจ ุงุณุชุจุฏุงู ูุฐุง ุจุนููุงู API ุงูุญูููู ููุชูุงูู ูุน SAP

            elements.apiStatus.textContent = 'ุฌุงุฑู ุงูุฅุฑุณุงู ุฅูู ุงูุฎุงุฏู...';
            elements.apiStatus.style.display = 'block';
            
            try {
                // ******************************************************************************
                // ููุงุญุธุฉ: ูุบุฑุถ ุงูุนุฑุถ ูู GitHub Pagesุ ุชู ุงูุชุนููู ุนูู ุทูุจ fetch ุงูุญูููู 
                // ูุชู ุงุณุชุฎุฏุงู ููุช ุงูุชุธุงุฑ ูุตุทูุน (setTimeout) ููุญุงูุงุฉ ูุฌุงุญ ุงูุฅุฑุณุงู.
                // ******************************************************************************
                
                // const response = await fetch(API_ENDPOINT, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(permitData)
                // });

                // ูุญุงูุงุฉ ุงุณุชุฌุงุจุฉ API ูุงุฌุญุฉ ุจุนุฏ 1.5 ุซุงููุฉ
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                const isSuccess = Math.random() > 0.1; // 90% ูุฑุตุฉ ูุฌุงุญ ูููุญุงูุงุฉ
                
                if (isSuccess) {
                    const permitId = "PTW-" + Math.floor(Math.random() * 10000);
                    elements.apiStatus.textContent = `โ ูุฌุงุญ! ุฑูู ุงูุงุนุชูุงุฏ ุงูุฌุฏูุฏ: ${permitId}. ุชู ุชุญุฏูุซ ุญุงูุฉ ุฃูุฑ ุตูุงูุฉ SAP.`;
                    elements.apiStatus.style.backgroundColor = '#dff0d8';
                    elements.apiStatus.style.color = '#3c763d';
                    elements.submitButton.disabled = true;

                    console.log("JSON Payload Sent:", permitData);
                    console.log("Simulated Success Response. Permit ID:", permitId);
                } else {
                    // ูุญุงูุงุฉ ูุดู ุงูุฎุงุฏู ุฃู ุฑูุถ ููุทูู ูุชุฃุฎุฑ
                    elements.apiStatus.textContent = `โ ูุดู ุงูุฅุฑุณุงู: ุงูุฎุงุฏู ุฑูุถ ุงูุทูุจ. ูุฑุฌู ูุฑุงุฌุนุฉ ุณุฌูุงุช API.`;
                    elements.apiStatus.style.backgroundColor = '#f2dede';
                    elements.apiStatus.style.color = '#a94442';
                }

            } catch (error) {
                elements.apiStatus.textContent = 'โ ูุดู ุงูุงุชุตุงู ุจุฎุงุฏู SAP/API. ูุฑุฌู ุงูุชุญูู ูู ุงูุฑุงุจุท ูุงูุดุจูุฉ.';
                elements.apiStatus.style.backgroundColor = '#f2dede';
                elements.apiStatus.style.color = '#a94442';
                console.error('Error sending data:', error);
            }
        }


        // 6. ุฑุจุท ุงูุฃุญุฏุงุซ ูุชุดุบูู ุงูุจุฏุงูุฉ

        Object.values(elements).forEach(el => {
            if (el && el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
                el.addEventListener('change', runAILogic);
                el.addEventListener('input', runAILogic);
            }
        });

        elements.dynamicChecklist.addEventListener('change', runAILogic);
        elements.printButton.addEventListener('click', function() { window.print(); });

        // ุฑุจุท ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ุจุฒุฑ ุงูุฅุฑุณุงู
        elements.submitButton.addEventListener('click', function(event) {
            event.preventDefault(); // ููุน ุงูุฅุฑุณุงู ุงูุงูุชุฑุงุถู ูููููุฐุฌ
            if (!elements.submitButton.disabled) {
                sendPermitData();
            } else {
                alert('ุงูุฑุฌุงุก ุญู ุฌููุน ูุดููุงุช ุงูุฑูุถ ูุจู ุงูุฅุฑุณุงู.');
            }
        });

        // ุชุดุบูู ุงูุจุฏุงูุฉ
        updatePermitType(); 
        runAILogic(); 
    </script>
</body>
</html>